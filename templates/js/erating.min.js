$(document).ready(function(){function i(b){$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/api/user-list-by-agency/"+b,success:function(a){h.clear().draw();var b=JSON.parse(a),c=b.map(function(a){var b=[];return b.push(a.id_pengguna),b.push(a.nama),b.push(a.jawatan),b.push(a.tahap),b.push('<a href="#" class="user_preview" id="'+a.id_pengguna+'">Lihat</a> / Padam'),b});h.rows.add(c),h.draw()},error:function(){alert("Unable to process this request...")}})}function j(b,c){var e,d=a+"/templates/images/noimage.png";"logo"==b?e=$("#file-logo"):"photo"==b&&(e=$("#file-photo"));var h=e[0].files,i=h[0],j=i.type;console.log("Image "+h[0]),console.log("Image type"+j);var k=["image/png","image/gif","image/jpeg","image/jpg"];if(j!=k[0]&&j!=k[1]&&j!=k[2]&&j!=k[3])return $("#preview-"+b).attr("src",d),$("#message-"+b).html("<p id='error'>Sila pilih logo mengikut format yang betul.</p><h4>Nota</h4><span id='error_message'>Hanya format png, gif atau jpg/jpeg sahaja dibenarkan.</span>"),!1;$("#message-"+b).html("");var l=new FileReader;l.onload=function(d){$("#preview-"+b).attr("width","100px"),$("#preview-"+b).attr("height","100px"),$("#preview-"+b).attr("src",d.target.result);var e='{"type":"'+b+'","parentid":"'+c+'","photo":"'+d.target.result+'"}';console.log(e),$.ajax({type:"POST",url:a+"index.php/image-set",data:{data:e},success:function(a){$("#file-"+b).replaceWith($("#file-"+b).clone()),alert("Successfully saved...")},error:function(){alert("Unable to process this request..")}})},l.readAsDataURL(i)}function k(b,c){$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/api/image-get/"+c,success:function(c){JsonEratingData=jQuery.parseJSON(c),$("#preview-"+b).attr("width","100px"),$("#preview-"+b).attr("height","100px"),JsonEratingData?$("#preview-"+b).attr("src",JsonEratingData.photo):$("#preview-"+b).attr("src",a+"/templates/images/noimage.png")},error:function(){alert("Unable to process this request...")}})}function l(b){$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/api/config-agency/"+b,success:function(a){JsonEratingData=jQuery.parseJSON(a),JsonEratingData&&($("#erating-soalan").val(JsonEratingData.Soalan_Ms),$("#erating-question").val(JsonEratingData.Soalan_En),$("#erating-smiley").val(JsonEratingData.Smiley))},error:function(){alert("Unable to process this request...")}})}var a=$("#domain").val(),c=($("#base_url").val(),$("#json_data").val()),d=a+"index.php/"+c,e=$("#loginId").val(),g=($("#recordId").val(),$("#tblListERating").DataTable({paging:!0,lengthChange:!0,searching:!0,ordering:!0,info:!0,processing:!0,sAjaxDataProp:"",serverSide:!1,ajax:d,autoWidth:!0,columns:[{data:"code_branch"},{data:"ministry"},{data:"department"},{data:"branch"},{data:"section"},{data:null,className:"center",defaultContent:'<a href="" class="rating_edit">Edit</a> / <a href="" class="rating_preview">View</a>'}],columnDefs:[{type:"date_update",targets:-1},{targets:[0],visible:!1,searchable:!1}],initComplete:function(){this.api().columns([1,2,3]).every(function(){var a=this,b=$('<select style="max-width:150px;"><option value=""></option></select>').appendTo($(a.header())).on("change",function(){var b=$.fn.dataTable.util.escapeRegex($(this).val());a.search(b?"^"+b+"$":"",!0,!1).draw()});a.data().unique().sort().each(function(a,c){b.append('<option value="'+a+'">'+a+"</option>")})})}})),h=$("#tblListUser").DataTable({paging:!0,lengthChange:!1,searching:!0,ordering:!0,info:!0,processing:!1,sAjaxDataProp:"",serverSide:!1,autoWidth:!0,columnDefs:[{type:"date_update",targets:-1},{targets:[0],visible:!1,searchable:!1}],dom:"lBfrtip",buttons:[{text:"Tambah",action:function(a,b,c,d){$("#frmUserInfo")[0].reset(),$("#addUserModal").modal("show"),$("#user-ic").removeAttr("disabled")}}]});setInterval(function(){g.ajax.reload()},3e4),$("a#erating-new").click(function(a){a.preventDefault(),$(":input:not(input[name=loginId])").val(""),$('.nav-tabs a[href="#erating-tabAgency"]').tab("show"),$('.nav-tabs a[href="#erating-tabAgency"]').addClass("active"),$("#erating-tabAgency").fadeIn(),$("#viewModal").modal("show")}),$("#tblListERating tbody").on("click","a.rating_edit",function(a){a.preventDefault();var b=g.row($(this).parents("tr")).data();$(".modal-body #recordId").val(b.code_branch),$("#editModal").modal("show")}),$("#tblListERating tbody").on("click","a.rating_preview",function(a){a.preventDefault();var b=g.row($(this).parents("tr")).data();$("#recordId").val(b.code_branch),$("#viewModal").modal("show")}),$("#dropdownMinistryAssign").change(function(){var b=$(this).val();console.log(b),$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/department-by-ministry/"+b,success:function(a){$("#dropdownDepartmentAssign").empty(),$("#dropdownBranchAssign").empty(),$("#dropdownDepartmentAssign").append('<option value="000000"> Sila Pilih </option>'),$("#dropdownBranchAssign").append('<option value="000000000"> Sila Pilih </option>');for(var b=0;b<a.length;b++){var c=$('<option value="'+a[b].Kod_Jab+'">'+a[b].Kod_Jab+" "+a[b].Jabatan+"</option>");$("#dropdownDepartmentAssign").append(c)}$("#dropdownDepartmentAssign").trigger("chosen:updated")},error:function(){alert("Unable to process this request...")}})}),$("#dropdownDepartmentAssign").change(function(){var b=$(this).val();console.log(b),$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/branch-by-department/"+b,success:function(a){$("#dropdownBranchAssign").empty(),$("#dropdownBranchAssign").append('<option value="000000000"> Sila Pilih </option>');for(var b=0;b<a.length;b++){var c=$('<option value="'+a[b].Kod_Caw+'">'+a[b].Kod_Caw+" "+a[b].cawangan+"</option>");$("#dropdownBranchAssign").append(c)}$("#dropdownBranchAssign").trigger("chosen:updated")},error:function(){alert("Unable to process this request...")}})}),$("#dropdownBranchAssign").change(function(){var a=$(this).val();console.log(a)}),$("#dropdownUsers").change(function(){var b=($("#dropdownUsers :selected").text(),$(this).val());console.log("User Id:"+b)}),$("#viewModal").on("show.bs.modal",function(b){var d=($(b.relatedTarget),$("#recordId").val()),f=($("#erating-tabs li"),$(this));if(console.log("viewModal Agency Id:"+d),null==d||""==d){var d=null;f.find(".modal-body #erating-tabDisplay").hide(),f.find(".modal-body #erating-tabConfig").hide(),f.find(".modal-body #erating-tabQuestion").hide(),f.find(".modal-body #erating-tabUser").hide(),f.find(".modal-body #btnSaveAgency").show(),f.find(".modal-body #btnUpdateAgency").hide()}else f.find(".modal-body #erating-tabDisplay").show(),f.find(".modal-body #erating-tabConfig").show(),f.find(".modal-body #erating-tabQuestion").show(),f.find(".modal-body #erating-tabUser").show(),f.find(".modal-body #btnSaveAgency").hide(),f.find(".modal-body #btnUpdateAgency").show();$(".modal-header #label-rekod").text("#"+d),$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/erating-details/"+d,success:function(a){console.log("Erating Details: "+a),JsonEratingData=jQuery.parseJSON(a),JsonEratingData&&(f.find(".modal-body #asnaf-id").val(d),f.find(".modal-body #erating-section").val(JsonEratingData.section),f.find(".modal-body #dropdownMinistryAssign").val(JsonEratingData.code_ministry),f.find(".modal-body #dropdownDepartmentAssign").empty(),f.find(".modal-body select#dropdownDepartmentAssign").append('<option value="'+JsonEratingData.code_department+'">'+JsonEratingData.department+"</option>"),f.find(".modal-body #dropdownBranchAssign").empty(),f.find(".modal-body select#dropdownBranchAssign").append('<option value="'+JsonEratingData.code_branch+'">'+JsonEratingData.branch+"</option>"),f.find(".modal-body #erating-status").val(""+JsonEratingData.status))},error:function(){alert("Unable to process this request...")}}),i(d),k("logo",d),l(d)}),$("#btnSaveAgency").click(function(){var b=$("#recordId").val(),c=$("#dropdownMinistryAssign :selected").val(),d=$("#dropdownDepartmentAssign :selected").val(),f=$("#dropdownBranchAssign :selected").val(),h=$("#erating-section").val(),i=$("#erating-status :selected").val(),j=Math.floor(999*Math.random())+100,k="";k=null==b||""==b?c.substring(0,3)+d.substring(3,6)+f.substring(6,9)+j:b;var l='{"Kod_Bah":"'+k+'","Bahagian":"'+h+'","Status":"'+i+'","Tindakan":"'+e+'"}';console.log(l),$.ajax({type:"POST",url:a+"index.php/erating-save-agency",data:{data:l},success:function(a){$(".modal-header #label-rekod").text("#"+k),$(".modal-body #recordId").val(k),$(".modal-body #erating-tabDisplay").show(),$(".modal-body #erating-tabConfig").show(),$(".modal-body #erating-tabQuestion").show(),$(".modal-body #erating-tabUser").show(),g.ajax.reload(),alert("Successfully saved...")},error:function(){alert("Unable to process this request..")}})}),$("#btnUpdateAgency").click(function(){var b=$("#recordId").val(),d=($("#loginId").val(),$("#erating-section").val()),f=$("#erating-status :selected").val(),h='{"Kod_Bah":"'+b+'","Bahagian":"'+d+'","Status":"'+f+'","Tindakan":"'+e+'"}';console.log(h),$.ajax({type:"POST",url:a+"index.php/erating-update-agency",data:{data:h},success:function(a){g.ajax.reload(),alert("Successfully saved...")},error:function(){alert("Unable to process this request..")}})}),$("#btnSaveConfig").click(function(){var b=$("#recordId").val(),c=$("#erating-soalan").val(),d=$("#erating-question").val(),e=$("#erating-smiley :selected").val(),f='{"Kod_Bah":"'+b+'","Soalan_Ms":"'+c+'","Soalan_En":"'+d+'","Smiley":"'+e+'"}';console.log(f),$.ajax({type:"POST",url:a+"index.php/erating-save-config",data:{data:f},success:function(a){$(".modal-body #recordId").val(b),$(".modal-body #erating-tabDisplay").show(),$(".modal-body #erating-tabConfig").show(),$(".modal-body #erating-tabQuestion").show(),$(".modal-body #erating-tabUser").show(),g.ajax.reload(),alert("Successfully saved...")},error:function(){alert("Unable to process this request..")}})}),$("#btnSaveUser").click(function(){var b=$("#userId").val(),c=$("#recordId").val(),d=$("#user-name").val(),e=$("#user-ic").val(),f=$("#user-pwd").val(),g=$("#user-post").val(),h=$("#user-email").val(),k=$("#user-phone").val(),l=$("#dropdown-user-access :selected").val(),m=$("#dropdown-user-status :selected").val(),n="",o="",p="";null==b||""==b?(n='{"kad_pengenalan":"'+e+'","kata_laluan":"'+f+'","nama":"'+d+'","jawatan":"'+g+'","emel":"'+h+'","no_telefon":"'+k+'","tahap":"'+l+'","status":"'+m+'","agensi_id":"'+c+'"}',o=a+"index.php/user-save",p="Initialiazing actions..."):(n='{"id_pengguna":"'+b+'","kad_pengenalan":"'+e+'","kata_laluan":"'+f+'","nama":"'+d+'","jawatan":"'+g+'","emel":"'+h+'","no_telefon":"'+k+'","tahap":"'+l+'","status":"'+m+'","agensi_id":"'+c+'"}',o=a+"index.php/user-update",p='<a href="#" class="user_preview" id="'+b+'">Lihat</a> / Padam'),$.ajax({type:"POST",url:o,data:{data:n},success:function(a){i(c),""!=$("#file-photo").val()&&j("photo",b),alert("Successfully saved...")},error:function(){alert("Unable to process this request..")}})}),$("#btnRemoveUser").click(function(){var b=$("#confirm-remove span").text(),c=$("#recordId").val();d='{"uid":"'+b+'"}',console.log(d),console.log(c),$.ajax({type:"POST",url:a+"index.php/user-remove",data:{data:d},success:function(a){i(c),$("#removeUserModal").modal("hide")},error:function(){alert("Unable to process this request..")}})}),$("#btnSaveDisplay").click(function(){var a=$("#recordId").val();""!=$("#file-logo").val()&&j("logo",a)}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(a){var b=$(a.target).attr("href");console.log(b)}),$("#tblListUser tbody").on("click","a.user_preview",function(a){a.preventDefault();var b=$(this).attr("id");$(".modal-body #userId").val(b),$("#addUserModal").modal("show")}),$("#tblListUser tbody").on("click","a.user_remove",function(a){a.preventDefault();var b=$(this).attr("id");$("#confirm-remove span").text(b),$("#removeUserModal").modal("show")}),$("#addUserModal").on("show.bs.modal",function(b){var c=$("#userId").val(),d=$(this),e=a+"/templates/images/noimage.png";if(null==c||""==c){console.log("Id: "+c);var c=null;$("#btnSaveUser span").text("Simpan"),$("#preview-photo").attr("src",e)}else $("#btnSaveUser span").text("Kemaskini");$.ajax({type:"GET",datatype:"jsonp",url:a+"index.php/user-details/"+c,success:function(a){console.log("User Details: "+a),JsonEratingData=jQuery.parseJSON(a),JsonEratingData&&(d.find(".modal-body #user-name").val(JsonEratingData.nama),d.find(".modal-body #user-ic").val(JsonEratingData.kad_pengenalan).attr("disabled","disabled"),d.find(".modal-body #user-login").val(JsonEratingData.nama_pengguna),d.find(".modal-body #user-pwd").val(JsonEratingData.kata_laluan),d.find(".modal-body #user-post").val(JsonEratingData.jawatan),d.find(".modal-body #user-email").val(JsonEratingData.emel),d.find(".modal-body #user-phone").val(JsonEratingData.no_telefon),d.find(".modal-body #dropdown-user-access").val(JsonEratingData.tahap),d.find(".modal-body #dropdown-user-status").val(JsonEratingData.status),$("#preview-photo").attr("width","100px"),$("#preview-photo").attr("height","100px"),JsonEratingData.photo?$("#preview-photo").attr("src",JsonEratingData.photo):$("#preview-photo").attr("src",e))},error:function(){alert("Unable to process this request...")}})})});